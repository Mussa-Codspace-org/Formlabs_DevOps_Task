
name: Minikube CI 
on: 
  push: 
    branches:
      - master
      
  pull_request:
    branches:
      - master

jobs:
  job1:
    runs-on: ubuntu-latest
    name: build and deploy to minikube
    steps:
    
     - name: Set up Docker Buildx
       uses: docker/setup-buildx-action@v2

     - name: Login to Docker Hub
       uses: docker/login-action@v1
       with: 
         username: ${{secrets.DOCKER_HUB_USERNAME}}
         password: ${{secrets.DOCKER_HUB_ACCESS_TOKEN}}

     - name: Build and push 
       uses: docker/build-push-action@v3
       with:
         push: true 
         tags: mussaeb/flassk_image:latest

     - uses: actions/checkout@v2
     - name: Start minikube
       uses: medyagh/setup-minikube@master

     - name: Try the cluster !

       run: kubectl get pods -A

     - name: Build image
       run: minikube image load ${{secrets.DOCKER_HUB_USERNAME}}/flask_image
     
   #    run: |

      #  export SHELL=/bin/bash

       # eval $(minikube -p minikube docker-env)

      #  docker build -f ./Dockerfile -t mussaeb/flask_image .

     #   echo -n "verifying images:"

    #    docker images        

     - name: Deploy to minikube

       run:

        kubectl apply -f Deployment.yml

     - name: Test service URLs

       run: |

        minikube service list
        
        minikube service flask-app-service

        kubectl get services
        
        echo "------------------opening the service------------------"

        curl $(minikube service flask-app-service --url)
